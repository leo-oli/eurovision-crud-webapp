{% extends "base.html" %}

{% block content %}

<ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item"><a href="/songs">Songs</a></li>
    <li class="breadcrumb-item" aria-current="page">New Song</li>
</ol>

{% if validation_error %}
<div class="alert alert-danger" role="alert">
    Empty or invalid fields. Try again.
</div>
{% endif %}


<form method="post" class="d-grid gap-3">
    <p class="required-note"><span class="text-danger">*</span> marked fields are required</p>

    <h4 class="mt-3">Song Information</h4>

    {% if action == "edit" %}
    <div class="form-group">
        <label for="song_id">ID</label>
        <input type="number" name="song_id" class="form-control" value="{{ song.song_id }}" readonly>
    </div>
    {% endif %}
    <div class="form-group">
        <label for="title">Title<span class="text-danger">*</span></label>
        <input type="text" name="title" class="form-control" value="{{ song.title }}" required>
    </div>
    <div class="form-group">
        <label for="composition_date">Composition Date<span class="text-danger">*</span></label>
        <input type="date" name="composition_date" class="form-control" value="{{ song.composition_date }}" required>
    </div>
    <div class="form-group">
        <label for="duration">Duration (in seconds)<span class="text-danger">*</span></label>
        <input type="number" min="0" max="180" name="duration" class="form-control" value="{{ song.duration }}"
            required>
    </div>
    <div class="form-group">
        <label for="genre">Genre<span class="text-danger">*</span></label>
        <input type="text" name="genre" class="form-control" value="{{ song.genre }}" required>
    </div>
    <div class="form-group">
        <label for="place">Place</label>
        <input type="number" min="0" name="place" class="form-control" value="{{ song.place }}">
    </div>
    <div class="form-group">
        <label for="votes">Votes</label>
        <input type="number" min="0" name="votes" class="form-control" value="{{ song.votes }}">
    </div>
    <div class="form-group">
        <label for="event_id">Event<span class="text-danger">*</span></label>
        <select name="event_id" class="form-select form-control" required>
            {% for event in events %}
            <option value="{{ event.event_id }}" {% if song.event_id==event.event_id %} selected {% endif %}>{{
                event.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="country_id">Country<span class="text-danger">*</span></label>
        <select name="country_id" class="form-select form-control">
            {% for country in countries %}
            <option value="{{ country.country_id }}" {% if song.country_id==country.country_id %} selected {% endif %}>
                {{ country.name }}</option>
            {% endfor %}
        </select>
    </div>

    <h4 class="mt-3">Language Information</h4>

    {% if action == "edit" %}
    <input type="hidden" id="language-count" value="{{ languages|length if song else 0 }}">
    {% else %}
    <input type="hidden" id="language-count" value="1">
    {% endif %}

    <div class="row w-75">
        <div class="column">
            <div class="row headerRow">
                <div class="col-3">Name<span class="text-danger">*</span></div>
                <div class="col-2">Speaker Count<span class="text-danger">*</span></div>
                <div class="col-3">Language Family<span class="text-danger">*</span></div>
                <div class="col-3">Country<span class="text-danger">*</span></div>
            </div>
        </div>
        <div class="formRowsContainer">
            {% if action == "edit" %}
            {% for language in languages %}
            <div class="formRow row col-15">
                <!-- loop.index starts from 1 i guess? -->
                <input type="hidden" name="language_id_{{ loop.index0 }}" value="{{ language.language_id }}">
                <div class="col-3">
                    <input type="text" name="name_{{ loop.index0 }}" class="form-control" value="{{language.name}}"
                        required>
                </div>
                <div class="col-2">
                    <input type="number" min="1" name="speaker_count_{{ loop.index0 }}" class="form-control"
                        value="{{language.speaker_count}}" required>
                </div>
                <div class="col-3">
                    <input type="text" name="language_family_{{ loop.index0 }}" class="form-control"
                        value="{{language.language_family}}" required>
                </div>
                <div class="col-3">
                    <select name="country_id_{{ loop.index0 }}" class="form-select form-control">
                        {% for country in countries %}
                        <option value="{{ country.country_id }}" {% if language.country_id==country.country_id %}
                            selected {% endif %}>{{ country.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-1">
                    {% if not loop.first %}
                    <button type="button" class="btn btn-danger removeLanguageBtn">Remove</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="formRow row col-15">
                <div class="col-3">
                    <input type="text" name="name_0" class="form-control required" required>
                </div>
                <div class="col-2">
                    <input type="number" name="speaker_count_0" class="form-control required" required>
                </div>
                <div class="col-3">
                    <input type="text" name="language_family_0" class="form-control required" required>
                </div>
                <div class="col-3">
                    <select name="country_id_0" class="form-select form-control" required>
                        {% for country in countries %}
                        <option value="{{ country.country_id }}">{{ country.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="mt-2">
            <button type="button" class="btn btn-primary" id="addLanguageBtn">Add Language</button>
        </div>
    </div>

    <input type="submit" class="btn btn-primary w-25" name="button" value="Submit">
</form>

<script>
    // JQuery
    // wait for the document to be ready
    $(document).ready(function () {

        // get the current language count from a hidden input field
        let languageCount = parseInt($("#language-count").val());

        // when the add language button is clicked
        $("#addLanguageBtn").click(function () {

            // create a new row with language input fields
            let formRow = `
                <div class="formRow row col-15">
                    <div class="col-3">
                        <input type="text" name="name_${languageCount}" class="form-control" required>
                    </div>
                    <div class="col-2">
                        <input type="number" min="1" name="speaker_count_${languageCount}" class="form-control" required>
                    </div>
                    <div class="col-3">
                        <input type="text" name="language_family_${languageCount}" class="form-control" required>
                    </div>
                    <div class="col-3">
                        <select name="country_id_${languageCount}" class="form-select form-control" required>
                            {% for country in countries %}
                            <option value="{{ country.country_id }}">{{ country.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-danger removeLanguageBtn">Remove</button>
                    </div>
                </div>
            `;

            // append the new row to the container
            $(".formRowsContainer").append(formRow);

            // increment the language count
            languageCount++;

            // update the hidden input field with the new language count
            $("#language-count").val(languageCount);
        });

        // Remove language row
        // when the remove language button is clicked
        $(".formRowsContainer").on("click", ".removeLanguageBtn", function () {
            // remove the closest row containing the button
            $(this).closest(".formRow").remove();

            // decrement the language count
            languageCount--;

            // update the hidden input field with the new language count
            $("#language-count").val(languageCount);
        });
    });


</script>

{% endblock %}